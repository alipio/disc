#!/usr/bin/env ruby

require 'disc'
require 'clap'

Clap.run ARGV,
  "-r" => lambda { |file| require file }

if defined?(Celluloid)
  concurrency = Integer(ENV.fetch('DISC_CONCURRENCY', '25'))
  $stdout.puts(
    "[Notice] Disc running in celluloid mode! Current DISC_CONCURRENCY is\
 #{ concurrency }."
  )

  Disc::Worker.send(:include, Celluloid)

  if defined?(Celluloid::SupervisionGroup)
    # Deprecated as of Celluloid 0.17, but still supported via "backported mode"
    class Disc::WorkerGroup < Celluloid::SupervisionGroup
      pool Disc::Worker,
            size: concurrency,
            as: :worker_pool,
            args: [{ run: true }]
    end

    Disc::WorkerGroup.run
  else
    Disc::Worker.pool(
      size: concurrency,
      args: [{ run: true }]
    )
  end
else
  $stdout.puts("[Notice] Disc running in non-threaded mode")
  Disc::Worker.run
end
